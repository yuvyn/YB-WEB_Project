<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>YB WEB - 문의 게시판</title>

    <!-- 폰트 -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">

    <!-- 공통 CSS -->
    <link rel="stylesheet" th:href="@{/css/board/QnABoard.css}">
    <link rel="stylesheet" th:href="@{/css/layout/header.css}">
    <link rel="stylesheet" th:href="@{/css/layout/footer.css}">
</head>
<body>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<div class="page">

    <!-- 상단 헤더 -->
    <th:block th:replace="~{layout/header :: header}"></th:block>

    <!-- 상단 타이틀 영역 -->
    <section class="inquiry-hero">
        <div class="content-inner">
            <div class="inquiry-hero-inner">
                <div class="inquiry-hero-text">
                    <span class="inquiry-badge">CUSTOMER CENTER</span>
                    <h1>문의 게시판</h1>
                    <p>
                        게임 이용 중 발생한 오류, 계정, 결제, 건의 사항을 남겨 주세요.<br>
                        빠르게 확인 후 답변을 드리겠습니다.
                    </p>
                </div>
                <div class="inquiry-hero-info">
                    <div class="info-line">
                        <span class="info-label">운영 시간</span>
                        <span class="info-value">평일 10:00 ~ 18:00 (주말·공휴일 휴무)</span>
                    </div>
                    <div class="info-line">
                        <span class="info-label">답변 소요 시간</span>
                        <span class="info-value">평균 1~2 영업일 내</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 본문: 문의 게시판 -->
    <section class="inquiry-section">
        <div class="content-inner inquiry-layout">

            <!-- 좌측: 카테고리 / 안내 -->
            <aside class="inquiry-side">
                <div class="side-card">
                    <h2>문의 유형</h2>
					<ul class="side-type-list">
					    <!-- 전체 -->
					    <li th:classappend="${category == null or category == 'ALL'} ? ' active'">
					        <a th:href="@{/board/qna(category='ALL', keyword=${keyword})}">전체 문의</a>
					    </li>

					    <!-- 계정/로그인 -->
					    <li th:classappend="${category == 'ACCOUNT'} ? ' active'">
					        <a th:href="@{/board/qna(category='ACCOUNT', keyword=${keyword})}">계정/로그인</a>
					    </li>

					    <!-- 결제/캐시 -->
					    <li th:classappend="${category == 'PAY'} ? ' active'">
					        <a th:href="@{/board/qna(category='PAY', keyword=${keyword})}">결제/캐시</a>
					    </li>

					    <!-- 게임 오류/버그 -->
					    <li th:classappend="${category == 'BUG'} ? ' active'">
					        <a th:href="@{/board/qna(category='BUG', keyword=${keyword})}">게임 오류/버그</a>
					    </li>

					    <!-- 건의/피드백 -->
					    <li th:classappend="${category == 'SUGGEST'} ? ' active'">
					        <a th:href="@{/board/qna(category='SUGGEST', keyword=${keyword})}">건의/피드백</a>
					    </li>

					    <!-- 기타 문의 -->
					    <li th:classappend="${category == 'ETC'} ? ' active'">
					        <a th:href="@{/board/qna(category='ETC', keyword=${keyword})}">기타 문의</a>
					    </li>
					</ul>
                </div>

                <div class="side-card notice">
                    <h2>안내사항</h2>
                    <ul>
                        <li>비속어, 욕설, 허위 사실 유포 시 제재될 수 있습니다.</li>
                        <li>계정/결제 문의는 본인 인증 후 보다 빠르게 처리됩니다.</li>
                        <li>중복 문의는 확인 및 답변이 지연될 수 있습니다.</li>
                    </ul>
                </div>
            </aside>

            <!-- 우측: 게시판 -->
            <div class="inquiry-main">
                <div class="board-header">
                    <div class="board-title">
                        <h2>문의 리스트</h2>
                        <span class="board-count">
                            총 <strong th:text="${totalCount}">0</strong>건
                        </span>
                    </div>

                    <!-- 검색 -->
                    <div class="board-actions">
                        <!-- 상태/검색 타입은 아직 기능 없이 UI만 유지 -->
                        <select class="select-small">
                            <option>전체 상태</option>
                            <option>접수</option>
                            <option>처리중</option>
                            <option>답변완료</option>
                        </select>

                        <form class="board-search" method="get" th:action="@{/board/qna}">
                            <input type="text" name="keyword"
                                   placeholder="검색어를 입력해 주세요"
                                   th:value="${keyword}">
                            <button type="submit">검색</button>
                        </form>

                        <!-- 글쓰기 버튼: QNA 타입으로 이동 -->
                        <a class="btn-write" th:href="@{'/board/QNA/write'}">문의 작성하기</a>
                    </div>
                </div>

                <!-- 게시판 리스트 -->
                <div class="board-card">
                    <table class="inquiry-table">
                        <colgroup>
                            <col style="width: 70px;">
                            <col style="width: 110px;">
                            <col>
                            <col style="width: 110px;">
                            <col style="width: 110px;">
                            <col style="width: 90px;">
                        </colgroup>
                        <thead>
                        <tr>
                            <th>번호</th>
                            <th>구분</th>
                            <th>제목</th>
                            <th>처리 상태</th>
                            <th>작성일</th>
                            <th>조회</th>
                        </tr>
                        </thead>
                        <tbody>
                        <!-- 글이 없을 때 -->
                        <tr th:if="${#lists.isEmpty(posts)}">
                            <td colspan="6" class="no-data">
                                등록된 문의가 없습니다.
                            </td>
                        </tr>

                        <!-- 문의 리스트 -->
                        <tr th:each="post, stat : ${posts}"
                            th:classappend="${post.noticePin} ? ' row-notice'">
                            <!-- 번호: 공지면 '공지', 아니면 순번 -->
                            <td th:text="${post.noticePin} ? '공지' : (${totalCount - stat.index})">

                            <!-- 구분: 지금은 일단 기타로 고정, 나중에 필드 추가해서 바꾸면 됨 -->
							<td>
							    <span class="badge"
							          th:classappend="${
							                post.noticePin} ? ' type-notice' :
							                (post.qnaCategory == 'ACCOUNT' ? ' type-account' :
							                (post.qnaCategory == 'PAY'     ? ' type-pay'     :
							                (post.qnaCategory == 'BUG'     ? ' type-bug'     :
							                (post.qnaCategory == 'SUGGEST' ? ' type-suggest' : ' type-etc'))))"
							          th:text="${post.noticePin} ? '안내' : ${post.qnaCategoryLabel}">
							        기타 문의
							    </span>
							</td>

                            <!-- 제목 -->
                            <td class="title">
                                <a th:href="@{'/board/QNA/' + ${post.id}}"
                                   th:text="${post.title}">
                                    제목
                                </a>
                            </td>

                            <!-- 처리 상태: 데모라 일단 '접수' 고정 -->
							<td>
							    <span class="badge"
							          th:classappend="${
							                post.qnaStatus} == 'DONE' ? ' status-done' :
							                (${post.qnaStatus} == 'IN_PROGRESS' ? ' status-ing' : ' status-new')"
							          th:text="${post.qnaStatusLabel}">
							        접수
							    </span>
							</td>

                            <!-- 작성일 -->
                            <td th:text="${#temporals.format(post.createdAt, 'yyyy.MM.dd')}">
                                2025.11.26
                            </td>

                            <!-- 조회수 -->
                            <td th:text="${post.viewCount}">0</td>
                        </tr>
                        </tbody>
                    </table>

                    <!-- 페이지네이션: 아직 페이징 안 쓰면 더미로 유지 -->
					<div class="pagination" th:if="${totalPages > 1}">

					    <!-- 맨 처음 페이지 (<<) -->
					    <a class="page-btn"
					       th:href="@{/board/{type}(type=${#strings.toLowerCase(boardType.name())},
					                                page=1,
					                                keyword=${keyword})}"
					       th:classappend="${page == 1} ? ' disabled'">
					        &laquo;
					    </a>

					    <!-- 이전 블록 (<) -->
					    <a class="page-btn"
					       th:if="${hasPrevBlock}"
					       th:href="@{/board/{type}(type=${#strings.toLowerCase(boardType.name())},
					                                page=${prevBlockPage},
					                                keyword=${keyword})}">
					        &lsaquo;
					    </a>
					    <span class="page-btn disabled"
					          th:if="${!hasPrevBlock}">
					        &lsaquo;
					    </span>

					    <!-- 페이지 숫자 5개 블록 -->
					    <a class="page-btn"
					       th:each="p : ${#numbers.sequence(startPage, endPage)}"
					       th:text="${p}"
					       th:classappend="${p == page} ? ' active'"
					       th:href="@{/board/{type}(type=${#strings.toLowerCase(boardType.name())},
					                                page=${p},
					                                keyword=${keyword})}">
					    </a>

					    <!-- 다음 블록 (>) -->
					    <a class="page-btn"
					       th:if="${hasNextBlock}"
					       th:href="@{/board/{type}(type=${#strings.toLowerCase(boardType.name())},
					                                page=${nextBlockPage},
					                                keyword=${keyword})}">
					        &rsaquo;
					    </a>
					    <span class="page-btn disabled"
					          th:if="${!hasNextBlock}">
					        &rsaquo;
					    </span>

					    <!-- 맨 끝 페이지 (>>) -->
					    <a class="page-btn"
					       th:href="@{/board/{type}(type=${#strings.toLowerCase(boardType.name())},
					                                page=${totalPages},
					                                keyword=${keyword})}"
					       th:classappend="${page == totalPages} ? ' disabled'">
					        &raquo;
					    </a>
					</div>
                </div>
            </div>
        </div>
    </section>

    <!-- 1:1 문의 실시간 채팅 위젯 (기존 그대로) -->
    <!-- 아래 스크립트는 그대로 두면 레이아웃에 영향 없음 -->
    <div class="inquiry-chat-launcher">
        <span>1:1 문의</span>
    </div>

    <div class="inquiry-chat-window">
        <div class="chat-header">
            <div class="chat-title">
                <span class="chat-badge">REAL-TIME</span>
                <h3>1:1 문의 채팅</h3>
            </div>
            <button class="chat-close" type="button">×</button>
        </div>

        <div class="chat-body">
            <!-- 초기 안내 메시지 -->
            <div class="chat-msg bot">
                <div class="bubble">
                    안녕하세요, YB WEB 고객센터입니다. 👋<br>
                    아래 빠른 문의 유형을 선택하시거나, 직접 내용을 입력해 주세요.
                </div>
                <span class="time">지금</span>
            </div>

            <!-- 빠른 선택 버튼들 (더미 챗봇용) -->
            <div class="chat-quick-wrap">
                <p class="chat-quick-title">자주 묻는 질문 바로가기</p>
                <div class="chat-quick-list">
                    <button type="button" class="chat-quick-btn" data-key="account">계정/로그인 문제</button>
                    <button type="button" class="chat-quick-btn" data-key="pay">결제/캐시 문의</button>
                    <button type="button" class="chat-quick-btn" data-key="bug">게임 오류/버그</button>
                    <button type="button" class="chat-quick-btn" data-key="event">이벤트/쿠폰 문의</button>
                    <button type="button" class="chat-quick-btn" data-key="human">상담원 연결 요청</button>
                </div>
            </div>
        </div>

        <form class="chat-input-area">
            <textarea rows="1"
                      placeholder="문의 내용을 입력해 주세요. (스크린샷 등은 게시판 문의를 이용해 주세요.)"></textarea>
            <button type="submit">전송</button>
        </form>
    </div>

</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const launcher = document.querySelector('.inquiry-chat-launcher');
        const chatWindow = document.querySelector('.inquiry-chat-window');
        const chatClose = document.querySelector('.chat-close');
        const chatBody = document.querySelector('.chat-body');
        const chatForm = document.querySelector('.chat-input-area');
        const chatTextarea = chatForm.querySelector('textarea');
        const quickButtons = document.querySelectorAll('.chat-quick-btn');

        // 현재 모드: bot(챗봇), agent_wait(상담원 대기), agent(상담원 연결됨)
        let chatMode = 'bot';
        let sessionId = null;
        let stompClient = null;
        let connected = false;

        // 더미 FAQ 답변 맵
        const quickAnswers = {
            account: '🔐 [계정/로그인 안내]\n\n' +
                '1) 비밀번호를 잊으신 경우, 로그인 화면의 "비밀번호 찾기"를 이용해 주세요.\n' +
                '2) 다른 플랫폼(스팀, 구글 등)과 연동한 경우, 해당 플랫폼 계정으로 로그인해야 합니다.\n' +
                '3) 계정 도용이 의심될 경우, 즉시 비밀번호를 변경하시고 문의 게시판으로 연락해 주세요.',
            pay: '💳 [결제/캐시 안내]\n\n' +
                '- 결제 후 10분 이내에 캐시/아이템이 지급되지 않았다면,\n' +
                '  ① 결제 내역 스크린샷\n' +
                '  ② 결제 일시 / 결제 수단\n' +
                '  ③ 캐릭터명 / 서버명\n' +
                '을 첨부하여 문의 게시판에 남겨 주세요.\n\n' +
                '중복 결제가 확인될 경우, 각 스토어/결제사 정책에 따라 환불이 진행됩니다.',
            bug: '🐞 [게임 오류/버그 안내]\n\n' +
                '게임 오류 발생 시, 아래 정보를 함께 남겨 주시면 빠른 확인에 도움이 됩니다.\n' +
                '  1) 발생 일시\n' +
                '  2) 사용 기기 / OS / 브라우저\n' +
                '  3) 오류 화면 스크린샷\n' +
                '  4) 재현 가능 여부 (어떤 행동 후 발생하는지)\n\n' +
                '심각한 버그의 경우, 패치 전까지 임시 조치 안내를 드릴 수 있습니다.',
            event: '🎁 [이벤트/쿠폰 안내]\n\n' +
                '- 이벤트 보상은 보통 지급일까지 최대 1~2영업일이 소요될 수 있습니다.\n' +
                '- 쿠폰 번호는 대소문자를 구분하며, 유효기간이 지난 쿠폰은 사용이 불가능합니다.\n\n' +
                '※ 특정 이벤트 보상 누락이 의심될 경우,\n' +
                '  참여 일시 / 이벤트 명 / 캐릭터명 을 함께 적어 문의해 주세요.'
            // human 은 아래에서 따로 처리
        };

        function openChat() {
            chatWindow.classList.add('open');
        }

        function closeChat() {
            chatWindow.classList.remove('open');
        }

        launcher.addEventListener('click', openChat);
        chatClose.addEventListener('click', closeChat);

        // 텍스트 영역 엔터로 전송 (shift+enter는 줄바꿈)
        chatTextarea.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatForm.requestSubmit();
            }
        });

        // 빠른 버튼(챗봇 + 상담원 연결) 클릭 이벤트
        quickButtons.forEach(function (btn) {
            btn.addEventListener('click', function () {
                const key = btn.dataset.key;
                const userText = btn.textContent.trim();

                // 내 말풍선
                appendMessage('user', userText);

                if (key === 'human') {
                    // 상담원 연결 요청 로직
                    requestAgent();
                    return;
                }

                const botText = quickAnswers[key] || '죄송합니다. 아직 준비되지 않은 항목입니다.';

                // 챗봇 응답
                setTimeout(function () {
                    appendMessage('bot', botText);
                }, 400);
            });
        });

        // 상담원 연결 요청(더미)
        async function requestAgent() {
    chatMode = 'agent_wait';
    appendSystemMessage('상담원 연결을 요청했습니다. 상담원이 수락하면 채팅이 시작됩니다.');

    try {
        // 1) 서버에 상담 요청 (세션 생성/재사용) -> sessionId 받기
        const res = await fetch('/api/user/support/request', { method:'POST' });
		if (!res.ok) throw new Error('상담 요청 실패');
		sessionId = await res.json();

        // 2) WebSocket 연결 + 구독
        connectWsAndSubscribe(sessionId);

        // 3) 상태 확인 폴링 (어드민이 acceptNext 해서 ACTIVE 되면 시작)
        startPollingForAccept(sessionId);

    } catch (e) {
        console.error(e);
        appendSystemMessage('상담 요청 중 오류가 발생했습니다. 잠시 후 다시 시도해 주세요.');
        chatMode = 'bot';
    }
}

        // 입력창 submit
        chatForm.addEventListener('submit', function (e) {
    e.preventDefault();
    const text = chatTextarea.value.trim();
    if (!text) return;

    if (chatMode !== 'agent') {
        appendSystemMessage('상담원이 수락한 뒤에 메시지를 보낼 수 있습니다.');
        chatTextarea.value = '';
        return;
    }

    if (!connected || !stompClient || !sessionId) {
        appendSystemMessage('채팅 연결이 준비되지 않았습니다. 잠시 후 다시 시도해 주세요.');
        return;
    }

    // 내 메시지는 UI에 즉시 표시(선택)
    appendMessage('user', text);
    chatTextarea.value = '';

    // 서버로 전송
    stompClient.send('/app/support/' + sessionId + '/send', {}, JSON.stringify({ text }));
});

        // 일반 메시지(유저/봇)
        function appendMessage(type, text) {
            const msg = document.createElement('div');
            msg.classList.add('chat-msg', type);

            const bubble = document.createElement('div');
            bubble.classList.add('bubble');
            bubble.innerText = text;

            const time = document.createElement('span');
            time.classList.add('time');
            const now = new Date();
            time.textContent =
                now.getHours().toString().padStart(2, '0') + ':' +
                now.getMinutes().toString().padStart(2, '0');

            msg.appendChild(bubble);
            msg.appendChild(time);

            chatBody.appendChild(msg);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        // 시스템 메시지 (가운데 얇은 문구)
        function appendSystemMessage(text) {
            const msg = document.createElement('div');
            msg.classList.add('chat-msg', 'system');

            const bubble = document.createElement('div');
            bubble.classList.add('bubble');
            bubble.innerText = text;

            msg.appendChild(bubble);

            chatBody.appendChild(msg);
            chatBody.scrollTop = chatBody.scrollHeight;
        }
        
        let subscription = null;

        function connectWsAndSubscribe(sessionId) {
          const doSubscribe = () => {
            if (subscription) subscription.unsubscribe();
            subscription = stompClient.subscribe('/topic/support/' + sessionId, function (frame) {
              const data = JSON.parse(frame.body);
              if (data.senderRole === 'USER') appendMessage('user', data.message);
              else if (data.senderRole === 'ADMIN') appendMessage('bot', `[상담원] ${data.message}`);
              else appendSystemMessage(data.message);
            });
          };

          // 이미 연결되어 있으면 구독만 갱신
          if (connected && stompClient) {
            doSubscribe();
            return;
          }

          const socket = new SockJS('/ws');
          stompClient = Stomp.over(socket);
          stompClient.debug = null;

          stompClient.connect({}, function () {
            connected = true;
            doSubscribe();
          });
        }
        
        let pollTimer = null;

        async function startPollingForAccept(sessionId) {
            if (pollTimer) clearInterval(pollTimer);

            pollTimer = setInterval(async function () {
                try {
                    // 세션 상태 확인용 API 하나 만들면 좋음
                    // 지금은 간단히 history 조회가 되면 ACTIVE라고 가정하는 방식은 위험해서
                    // 아래처럼 status API를 추가하는 걸 추천함.
                    const res = await fetch('/api/user/support/status/' + sessionId); // 아래 서버 코드 참고
                    if (!res.ok) return;
                    const status = (await res.text()).trim(); // "WAITING" or "ACTIVE" or "CLOSED"

                    if (status === 'ACTIVE') {
                        clearInterval(pollTimer);
                        pollTimer = null;

                        chatMode = 'agent';
                        appendSystemMessage('상담원이 연결되었습니다. 문의 내용을 입력해 주세요.');
                        // (선택) 기존 히스토리 불러오기
                        loadHistory(sessionId);
                    }
                } catch (e) {}
            }, 1500);
        }

        async function loadHistory(sessionId) {
            try {
                const res = await fetch('/api/user/support/history/' + sessionId);
                if (!res.ok) return;
                const history = await res.json();
                history.forEach(m => {
                    if (m.senderRole === 'USER') appendMessage('user', m.message);
                    else if (m.senderRole === 'ADMIN') appendMessage('bot', `[상담원] ${m.message}`);
                    else appendSystemMessage(m.message);
                });
            } catch (e) {}
        }
    });
</script>

<!-- 공통 푸터 -->
    <th:block th:replace="layout/footer :: footer"></th:block>
    
</body>
</html>