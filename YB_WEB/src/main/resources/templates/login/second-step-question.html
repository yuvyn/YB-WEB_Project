<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>YB WEB 2ë‹¨ê³„ ë³¸ì¸ì¸ì¦</title>
<link rel="stylesheet" th:href="@{/css/login.css}">
<link rel="stylesheet" th:href="@{/css/layout/header.css}">
<link rel="stylesheet" th:href="@{/css/layout/footer.css}">
</head>
<body class="login-page">

<th:block th:replace="~{layout/header :: header}"></th:block>

<main class="login-main">
    <div class="login-wrap">
        <div class="login-card">

            <div class="login-header">
                <div class="login-logo-text">YB WEB</div>
                <div class="login-subtitle">2ë‹¨ê³„ ë³¸ì¸ ì¸ì¦ì„ ì§„í–‰í•´ ì£¼ì„¸ìš”.</div>
            </div>

            <!-- ğŸ”¹ íƒ­ ì˜ì—­ (ë„¤ê°€ ë§Œë“  CSS ê·¸ëŒ€ë¡œ ì‚¬ìš©) -->
            <div class="second-method-tabs">
                <label class="second-method-option">
                    <input type="radio"
                           name="method"
                           value="QUESTION"
                           th:checked="${!(forceEmailTab == true or emailSent == true)}">
                    <span>ë³¸ì¸í™•ì¸ ì§ˆë¬¸</span>
                </label>
                <label class="second-method-option">
                    <input type="radio"
                           name="method"
                           value="EMAIL"
                           th:checked="${forceEmailTab == true or emailSent == true}">
                    <span>ì´ë©”ì¼ ì¸ì¦</span>
                </label>
            </div>

            <!-- ğŸ”¹ ì§ˆë¬¸ ë°©ì‹ -->
            <form th:action="@{/login/second}" method="post">
                <div class="second-panel" id="panel-question">
                    <div class="field">
                        <label>ë³¸ì¸í™•ì¸ ì§ˆë¬¸</label>
                        <div class="second-question" th:text="${question}">ì§ˆë¬¸ ë‚´ìš©</div>
                    </div>

                    <div class="field">
                        <label for="answer">ë‹µë³€</label>
                        <input type="text" id="answer" name="answer"
                               placeholder="ì§ˆë¬¸ì— ëŒ€í•œ ë‹µì„ ì…ë ¥í•´ ì£¼ì„¸ìš”">
                    </div>

                    <button type="submit" class="login-submit-btn">
                        ë³¸ì¸í™•ì¸ ì™„ë£Œ
                    </button>
                </div>
            </form>

            <!-- ğŸ”¹ ì´ë©”ì¼ ë°©ì‹ -->
            <div class="second-panel" id="panel-email" style="display:none;">

                <!-- ë§ˆìŠ¤í‚¹ëœ ì´ë©”ì¼ í‘œì‹œ -->
                <div class="field">
                    <label>ì¸ì¦ ì´ë©”ì¼</label>
                    <div class="second-email" th:text="${maskedEmail}">t***t@naver.com</div>
                </div>

                <!-- ì¸ì¦ë²ˆí˜¸ ë°œì†¡ ë²„íŠ¼ -->
                <form th:action="@{/email/send}" method="post" style="margin-top:8px;">
                    <input type="hidden" name="email" th:value="${email}">
                    <button type="submit" class="login-submit-btn" style="background:#4f46e5;">
                        ğŸ“© ì¸ì¦ë²ˆí˜¸ ë³´ë‚´ê¸°
                    </button>
                </form>

                <!-- ë°œì†¡ ì•ˆë‚´ + íƒ€ì´ë¨¸ -->
                <div th:if="${emailSent}" class="info-msg" style="margin-top:10px; font-size:13px;">
                    <span th:text="|ì¸ì¦ë²ˆí˜¸ê°€ ${maskedEmail} ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.|">
                        ì¸ì¦ë²ˆí˜¸ê°€ t***t@naver.com ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.
                    </span><br>
                    <span>3ë¶„ ì•ˆì— ì•„ë˜ì— ì¸ì¦ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</span>
                </div>

                <!-- íƒ€ì´ë¨¸ ì˜ì—­ -->
                <div id="email-timer-wrapper"
				     th:if="${emailSent} and remainSec != null"
				     style="margin-top:8px;">
				    <span style="font-size:13px; color:#6b7280;">ë‚¨ì€ ì‹œê°„</span>
				    <span id="email-timer"
				          th:data-seconds="${remainSec}"
				          style="margin-left:6px; font-weight:600; color:#ef4444;">
				        03:00
				    </span>
				</div>

				<!-- ë§Œë£Œ ì•ˆë‚´ (ì„œë²„ì—ì„œ expired=true ì£¼ë©´ ë…¸ì¶œ) -->
				<div id="expire-msg"
				     th:if="${expired}"
				     style="margin-top:8px; font-size:12px; color:#b91c1c;">
				    ì¸ì¦ë²ˆí˜¸ê°€ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì¸ì¦ë²ˆí˜¸ë¥¼ ìš”ì²­í•´ ì£¼ì„¸ìš”.
				</div>

                <!-- ì¸ì¦ë²ˆí˜¸ ì…ë ¥ -->
                <form th:action="@{/email/verify}" method="post" style="margin-top:14px;" id="emailVerifyForm">
                    <input type="hidden" name="email" th:value="${email}">

                    <div class="field">
                        <label for="code">ì¸ì¦ë²ˆí˜¸</label>
                        <input type="text" id="code" name="code"
                               placeholder="ë©”ì¼ë¡œ ë°›ì€ 6ìë¦¬ ì¸ì¦ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”">
                    </div>

                    <!-- ì½”ë“œ ë¶ˆì¼ì¹˜ / ë§Œë£Œ ë“± ì„œë²„ ë©”ì‹œì§€ -->
				    <div th:if="${error}" class="error-msg" th:text="${error}"></div>
				
				    <button type="submit"
				            id="emailVerifyBtn"
				            class="login-submit-btn"
				            style="margin-top:10px; background:#059669;"
				            th:disabled="${emailSent != true}">
				        ì¸ì¦ í™•ì¸
				    </button>
				    
				    <div th:if="${emailSent != true}"
					     style="margin-top:6px; font-size:12px; color:#6b7280;">
					    ë¨¼ì € ì¸ì¦ë²ˆí˜¸ë¥¼ ë³´ë‚´ì‹  í›„ì— ì¸ì¦ì„ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
					</div>
                </form>

                <!-- ë§Œë£Œ ì•ˆë‚´ -->
                <div id="expire-msg"
                     style="margin-top:8px; font-size:12px; color:#b91c1c; display:none;">
                    ì¸ì¦ë²ˆí˜¸ê°€ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì¸ì¦ë²ˆí˜¸ë¥¼ ìš”ì²­í•´ ì£¼ì„¸ìš”.
                </div>

            </div>

        </div>
    </div>
</main>

<th:block th:replace="~{layout/footer :: footer}"></th:block>

<!-- ğŸ”¹ íƒ­ ì „í™˜ + íƒ€ì´ë¨¸ ìŠ¤í¬ë¦½íŠ¸ (ë””ìì¸ ì•ˆ ê±´ë“œë¦¬ê³  ë™ì‘ë§Œ ë‹´ë‹¹) -->
<script th:inline="javascript">
document.addEventListener("DOMContentLoaded", function () {

    const methodRadios = document.querySelectorAll("input[name='method']");
    const panelQuestion = document.getElementById("panel-question");
    const panelEmail = document.getElementById("panel-email");

    // ì„œë²„ì—ì„œ ë‚´ë ¤ì˜¨ ê°’ (ì—†ìœ¼ë©´ false)
    const forceEmailTab = /*[[${forceEmailTab}]]*/ false;
    const emailSent     = /*[[${emailSent}]]*/ false;

    // ì²˜ìŒ ë¡œë”© ì‹œ ì–´ë–¤ íŒ¨ë„ ë³´ì—¬ì¤„ì§€
    if (forceEmailTab || emailSent) {
        panelQuestion.style.display = "none";
        panelEmail.style.display = "block";
    } else {
        panelQuestion.style.display = "block";
        panelEmail.style.display = "none";
    }

    // ë¼ë””ì˜¤ í´ë¦­ ì‹œ íŒ¨ë„ ì „í™˜
    methodRadios.forEach(radio => {
        radio.addEventListener("change", function () {
            if (this.value === "QUESTION") {
                panelQuestion.style.display = "block";
                panelEmail.style.display = "none";
            } else {
                panelQuestion.style.display = "none";
                panelEmail.style.display = "block";
            }
        });
    });

    // â± ì´ë©”ì¼ íƒ€ì´ë¨¸
    const timerEl = document.getElementById("email-timer");
    if (timerEl) {
        let seconds = parseInt(timerEl.getAttribute("data-seconds"), 10) || 180;
        const btn = document.getElementById("emailVerifyBtn");
        const expireMsg = document.getElementById("expire-msg");

        const intervalId = setInterval(function () {
            if (seconds <= 0) {
                clearInterval(intervalId);
                timerEl.textContent = "00:00";
                if (btn) {
                    btn.disabled = true;
                    btn.style.opacity = "0.6";
                    btn.style.cursor = "not-allowed";
                }
                if (expireMsg) {
                    expireMsg.style.display = "block";
                }
                return;
            }

            seconds--;
            const m = String(Math.floor(seconds / 60)).padStart(2, "0");
            const s = String(seconds % 60).padStart(2, "0");
            timerEl.textContent = m + ":" + s;
        }, 1000);
    }
});
</script>

</body>
</html>