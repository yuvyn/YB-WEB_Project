<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Admin - Support Chat</title>

  <!-- ê´€ë¦¬ì ê³µí†µ CSS(ë°©ê¸ˆ ë§Œë“  ê²ƒ) -->
  <link rel="stylesheet" th:href="@{/css/admin/admin.css}">
  <!-- ìƒë‹´ ì „ìš© ì˜¤ë²„ë¼ì´ë“œ -->
  <link rel="stylesheet" th:href="@{/css/admin/support_chat.css}">
</head>
<body>

<div class="admin-shell">

  <!-- ===== ì¢Œì¸¡ ì‚¬ì´ë“œë°” (admin.cssì™€ ë™ì¼í•œ êµ¬ì¡°) ===== -->
  <aside class="admin-aside">
    <div class="brand">
      <div class="brand-logo">YB</div>
      <div class="brand-text">
        <strong>YB WEB</strong>
        <span>Admin Console</span>
      </div>
    </div>

    <div class="profile-card" th:if="${member != null}">
  <div class="profile-avatar"
       th:text="${#strings.substring(member.nickname, 0, 1)}">Y</div>

  <div class="profile-meta">
    <strong>
      <span th:text="${member.nickname}">ë‹‰ë„¤ì„</span>
      <span th:text="| (${member.role})|">(ADMIN)</span>
    </strong>

    <span class="muted"
          th:text="${member.loginId}">loginId</span>

    <!-- ì›í•˜ë©´ ì´ë©”ì¼ë„ -->
    <span class="muted"
          th:text="${member.email}">email</span>
  </div>

  <!-- Spring Security ì“°ë©´ /logout POST ê¶Œì¥ -->
  <form th:action="@{/logout}" method="post" style="margin:0;">
    <button class="profile-logout" type="submit">ë¡œê·¸ì•„ì›ƒ</button>
  </form>
</div>

<!-- memberê°€ ì—†ì„ ë•Œ fallback -->
<div class="profile-card" th:if="${member == null}">
  <div class="profile-avatar">?</div>
  <div class="profile-meta">
    <strong>Unknown</strong>
    <span class="muted">Not logged in</span>
  </div>
</div>

    <nav class="nav">
      <div class="nav-group">
        <div class="nav-title">ì‹œìŠ¤í…œ ê´€ë¦¬</div>
        <a class="nav-item" href="/admin">
          <span class="dot"></span> ëŒ€ì‹œë³´ë“œ
        </a>
        <a class="nav-item" href="#">
          <span class="dot"></span> ì½”ë“œ ê´€ë¦¬
        </a>
        <a class="nav-item" href="#">
          <span class="dot"></span> ê¶Œí•œ ê´€ë¦¬
        </a>
        <a class="nav-item" href="#">
          <span class="dot"></span> ê´€ë¦¬ì ê´€ë¦¬
        </a>
      </div>

      <div class="nav-group">
        <div class="nav-title">ê°œì¸ì •ë³´ ì ‘ì†ê¸°ë¡</div>
        <a class="nav-item" href="/admin/access-log">
          <span class="dot"></span> ì ‘ì† ê¸°ë¡ ì¡°íšŒ
        </a>
        <a class="nav-item" href="#">
          <span class="dot"></span> ë¹„ì •ìƒí–‰ìœ„ ì¡°íšŒ
        </a>
      </div>

      <div class="nav-group">
        <div class="nav-title">íšŒì›/ìš´ì˜</div>
        <a class="nav-item" href="#"><span class="dot"></span> íšŒì› ê´€ë¦¬</a>
        <a class="nav-item" href="#"><span class="dot"></span> ê¸°íƒ€ ê´€ë¦¬</a>
        <a class="nav-item active" href="/admin/support"><span class="dot"></span> 1:1 ìƒë‹´</a>
        <a class="nav-item" href="#"><span class="dot"></span> ë¬¸ì˜ ê²Œì‹œíŒ</a>
      </div>
    </nav>

    <div class="aside-footer">
      <div class="aside-tip">
        <strong>Tip</strong>
        <span>ëŒ€ê¸° ìƒë‹´ì€ â€œë‹¤ìŒ ìƒë‹´ ìˆ˜ë½â€ìœ¼ë¡œ ë°”ë¡œ ì—°ê²°í•˜ì„¸ìš”.</span>
      </div>
      <div class="aside-copy">Â© YB WEB</div>
    </div>
  </aside>

  <!-- ===== ë©”ì¸ ===== -->
  <main class="admin-main">

    <!-- ìƒë‹¨ íƒ­ -->
    <header class="topbar">
      <div class="tabs">
        <a class="tab" href="#"><span class="tab-ico">ğŸ </span> í™ˆ<button class="tab-x" type="button">Ã—</button></a>
        <a class="tab active" href="#"><span class="tab-ico">ğŸ’¬</span> 1:1 ìƒë‹´<button class="tab-x" type="button">Ã—</button></a>
      </div>

      <div class="topbar-actions">
        <div class="searchbox">
          <span class="s-ico">âŒ•</span>
          <input type="text" placeholder="ì„¸ì…˜/ìœ ì € ê²€ìƒ‰..." />
        </div>
        <button class="icon-btn" type="button" title="ì„¤ì •">âš™ï¸</button>
      </div>
    </header>

    <section class="content">

      <div class="page-head">
        <div class="page-title">
          <h1>ê³ ê°ì„¼í„° 1:1 ìƒë‹´</h1>
          <p>ëŒ€ê¸° ì„¸ì…˜ì„ ìˆ˜ë½í•˜ê³  ì‹¤ì‹œê°„ ì±„íŒ…ìœ¼ë¡œ ì‘ëŒ€í•©ë‹ˆë‹¤.</p>
        </div>
        <div class="crumbs">
          <span>ê³ ê°ì„¼í„°</span><span class="sep">â€º</span><span class="current">1:1 ìƒë‹´</span>
        </div>
      </div>

      <!-- ìœ„ìª½ ìƒíƒœ/ë°°ë„ˆ -->
      <div class="hero-strip">
        <div class="hero-left">
          <span class="badge">SUPPORT</span>
          <strong>ì‹¤ì‹œê°„ ìƒë‹´ ìš´ì˜</strong>
          <p>ëŒ€ê¸° ëª©ë¡ â†’ ìˆ˜ë½ â†’ ì§„í–‰ â†’ ì¢…ë£Œ ìˆœì„œë¡œ ì²˜ë¦¬í•˜ì„¸ìš”.</p>
        </div>
        <div class="hero-right">
          <div class="mini-stat">
            <span class="k">ëŒ€ê¸°</span>
            <span class="v" id="waitCount">0</span>
          </div>
          <div class="mini-stat">
            <span class="k">í˜„ì¬ ì„¸ì…˜</span>
            <span class="v" id="activeSession">-</span>
          </div>
        </div>
      </div>

      <!-- ë©”ì¸ 2ì—´ -->
      <div class="support-grid">

        <!-- LEFT: WAITING -->
        <section class="card support-panel">
          <div class="card-head">
            <h2>ëŒ€ê¸°ì¤‘(WAITING)</h2>
            <div class="actions">
              <button class="btn dark" id="btnAcceptNext" type="button">ë‹¤ìŒ ìƒë‹´ ìˆ˜ë½</button>
            </div>
          </div>

          <ul class="waiting-list" id="waitingList"></ul>

          <div class="panel-foot muted">
            * ëª©ë¡ì€ ìë™ ê°±ì‹ ë©ë‹ˆë‹¤.
          </div>
        </section>

        <!-- RIGHT: CHAT -->
        <section class="card support-chat">
          <div class="support-chat-head">
            <div>
              <h2 class="chat-title">
                ì§„í–‰ ìƒíƒœ <span class="chat-pill" id="statusText">ëŒ€ê¸°ì¤‘ì¸ ìƒë‹´ì„ ìˆ˜ë½í•´ ì£¼ì„¸ìš”.</span>
              </h2>
              <div class="chat-sub">
                ì„¸ì…˜: <strong id="activeSessionTop">-</strong>
              </div>
            </div>

            <div class="actions">
              <button class="btn soft" type="button" id="btnClose">ìƒë‹´ ì¢…ë£Œ</button>
            </div>
          </div>

          <div class="chat-body" id="msgbox"></div>

          <div class="chat-input">
            <input id="text" placeholder="ë©”ì‹œì§€ ì…ë ¥..." />
            <button class="btn dark" id="btnSend" type="button">ì „ì†¡</button>
          </div>
        </section>

      </div>
    </section>
  </main>
</div>

<!-- SockJS / STOMP -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script>
  const waitingListEl = document.getElementById('waitingList');
  const waitCountEl = document.getElementById('waitCount');
  const msgbox = document.getElementById('msgbox');
  const activeSessionEl = document.getElementById('activeSession');
  const activeSessionTop = document.getElementById('activeSessionTop');
  const statusTextEl = document.getElementById('statusText');

  const btnAcceptNext = document.getElementById('btnAcceptNext');
  const btnSend = document.getElementById('btnSend');
  const btnClose = document.getElementById('btnClose');
  const textEl = document.getElementById('text');

  let activeSessionId = null;
  let stompClient = null;
  let subscribed = false;

  function appendSys(text){
    const div = document.createElement('div');
    div.className = 'chat-msg system';
    div.textContent = text;
    msgbox.appendChild(div);
    msgbox.scrollTop = msgbox.scrollHeight;
  }
  function appendMsg(who, text){
    const div = document.createElement('div');
    div.className = 'chat-msg ' + (who === 'ADMIN' ? 'admin' : 'user');
    div.innerHTML = `
      <div class="who">${who === 'ADMIN' ? 'ADMIN' : 'USER'}</div>
      <div class="bubble">${escapeHtml(text)}</div>
    `;
    msgbox.appendChild(div);
    msgbox.scrollTop = msgbox.scrollHeight;
  }
  function escapeHtml(s){
    return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
  }

  async function loadWaiting(){
    const res = await fetch('/api/admin/support/waiting');
    if(!res.ok) return;
    const list = await res.json();
    waitCountEl.textContent = list.length;
    waitingListEl.innerHTML = '';
    list.forEach(item => {
      const li = document.createElement('li');
      li.className = 'waiting-item';
      li.innerHTML = `
        <div class="w-meta">
          <strong>session #${item.id}</strong>
          <span>user: ${item.userMemberId}</span>
        </div>
        <button class="btn" data-id="${item.id}" type="button">ìˆ˜ë½</button>
      `;
      li.querySelector('button').addEventListener('click', async () => {
        await acceptSession(item.id);
      });
      waitingListEl.appendChild(li);
    });
  }

  function connectWs(){
    if(stompClient) return;
    const socket = new SockJS('/ws');
    stompClient = Stomp.over(socket);
    stompClient.debug = null;
    stompClient.connect({}, () => {
      appendSys('WebSocket ì—°ê²°ë¨');
      if(activeSessionId) subscribeSession(activeSessionId);
    });
  }

  function subscribeSession(sessionId){
    if(!stompClient || subscribed) return;
    stompClient.subscribe('/topic/support/' + sessionId, (frame) => {
      const data = JSON.parse(frame.body);
      if(data.senderRole === 'USER'){
        appendMsg('USER', data.message);
      } else if(data.senderRole === 'ADMIN'){
        appendMsg('ADMIN', data.message);
      } else {
        appendSys(data.message);
      }
    });
    subscribed = true;
  }

  async function loadHistory(sessionId){
    const res = await fetch('/api/admin/support/history/' + sessionId);
    if(!res.ok) return;
    const history = await res.json();
    msgbox.innerHTML = '';
    history.forEach(m => {
      if(m.senderRole === 'USER') appendMsg('USER', m.message);
      else if(m.senderRole === 'ADMIN') appendMsg('ADMIN', m.message);
      else appendSys(m.message);
    });
  }

  async function acceptSession(sessionId){
    const res = await fetch('/api/admin/support/' + sessionId + '/accept', { method:'POST' });
    if(!res.ok){
      appendSys('ìˆ˜ë½ ì‹¤íŒ¨: ' + res.status);
      return;
    }
    const acceptedId = await res.json();
    activeSessionId = acceptedId;
    activeSessionEl.textContent = acceptedId;
    activeSessionTop.textContent = acceptedId;
    statusTextEl.textContent = 'ìƒë‹´ ì§„í–‰ì¤‘(ACTIVE)';
    subscribed = false;
    connectWs();
    subscribeSession(activeSessionId);
    await loadHistory(activeSessionId);
    await loadWaiting();
  }

  btnAcceptNext.addEventListener('click', async () => {
    const res = await fetch('/api/admin/support/accept-next', { method:'POST' });
    if(!res.ok){
      appendSys('ë‹¤ìŒ ìƒë‹´ ìˆ˜ë½ ì‹¤íŒ¨: ' + res.status);
      return;
    }
    const acceptedId = await res.json();
    activeSessionId = acceptedId;
    activeSessionEl.textContent = acceptedId;
    activeSessionTop.textContent = acceptedId;
    statusTextEl.textContent = 'ìƒë‹´ ì§„í–‰ì¤‘(ACTIVE)';
    subscribed = false;
    connectWs();
    subscribeSession(activeSessionId);
    await loadHistory(activeSessionId);
    await loadWaiting();
  });

  btnSend.addEventListener('click', () => {
    const text = textEl.value.trim();
    if(!text) return;
    if(!activeSessionId || !stompClient){
      appendSys('ë¨¼ì € ìƒë‹´ì„ ìˆ˜ë½í•˜ì„¸ìš”.');
      return;
    }
    stompClient.send('/app/support/' + activeSessionId + '/send', {}, JSON.stringify({ text }));
    textEl.value = '';
  });

  textEl.addEventListener('keydown', (e) => {
    if(e.key === 'Enter'){
      e.preventDefault();
      btnSend.click();
    }
  });

  btnClose.addEventListener('click', async () => {
    if(!activeSessionId) return;
    const res = await fetch('/api/admin/support/' + activeSessionId + '/close', { method:'POST' });
    if(res.ok){
      appendSys('ìƒë‹´ ì¢…ë£Œë¨');
      statusTextEl.textContent = 'ìƒë‹´ ì¢…ë£Œ(CLOSED)';
      activeSessionId = null;
      activeSessionEl.textContent = '-';
      activeSessionTop.textContent = '-';
      subscribed = false;
      await loadWaiting();
    } else {
      appendSys('ì¢…ë£Œ ì‹¤íŒ¨: ' + res.status);
    }
  });

  connectWs();
  loadWaiting();
  setInterval(loadWaiting, 2000);
</script>
</body>
</html>